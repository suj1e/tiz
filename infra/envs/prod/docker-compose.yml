# Production 环境基础设施配置
# 使用方式: docker-compose up -d

# 全局日志配置
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "100m"
    max-file: "10"

# 网络定义
networks:
  npass:
    external: true

# 数据卷定义 (宿主机目录)
volumes:
  mysql-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/tiz/data}/mysql
  redis-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/tiz/data}/redis
  elasticsearch-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/tiz/data}/elasticsearch
  nacos-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/tiz/data}/nacos
  kafka-data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-/opt/tiz/data}/kafka

services:
  # ==================== MySQL ====================
  mysql:
    image: mysql:9.2
    container_name: tiz-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: tiz
      MYSQL_USER: tiz
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      TZ: Asia/Shanghai
    # 生产环境不暴露端口到宿主机，仅通过 Docker 网络访问
    expose:
      - "3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ../../config/docker/mysql/init:/docker-entrypoint-initdb.d:ro
    command:
      - --max_connections=2000
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - "--default-time-zone=+08:00"
      - --sql_mode=STRICT_TRANS_TABLES,NO_ZERO_DATE,NO_ZERO_IN_DATE,ERROR_FOR_DIVISION_BY_ZERO
      - --innodb_buffer_pool_size=2G
      - --log_bin=ON
      - --binlog_format=ROW
      - --sync_binlog=1
      - --innodb_flush_log_at_trx_commit=1
    networks:
      - npass
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging: *default-logging

  # ==================== Redis ====================
  redis:
    image: redis:7.4-alpine
    container_name: tiz-redis
    restart: always
    expose:
      - "6379"
    volumes:
      - redis-data:/data
      - ../../config/docker/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: sh -c "redis-server /usr/local/etc/redis/redis.conf --requirepass $$REDIS_PASSWORD --maxmemory 2gb --maxmemory-policy allkeys-lru --appendonly yes"
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "$$REDIS_PASSWORD", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging: *default-logging

  # ==================== Elasticsearch ====================
  elasticsearch:
    image: elasticsearch:8.19.1
    container_name: tiz-elasticsearch
    restart: always
    environment:
      - node.name=es-node-1
      - cluster.name=tiz-cluster
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "ES_JAVA_OPTS=-Xms2g -Xmx2g"
      - xpack.security.enabled=true
      - xpack.security.enrollment.enabled=false
      - ELASTIC_PASSWORD=${ELASTIC_PASSWORD}
      - xpack.security.http.ssl.enabled=false
      - xpack.security.transport.ssl.enabled=false
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    expose:
      - "9200"
    volumes:
      - elasticsearch-data:/usr/share/elasticsearch/data
    networks:
      - npass
    healthcheck:
      test: ["CMD-SHELL", "curl -f -u elastic:$$ELASTIC_PASSWORD http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    logging: *default-logging

  # ==================== Nacos ====================
  nacos:
    image: nacos/nacos-server:v3.1.1
    container_name: tiz-nacos
    restart: always
    environment:
      - MODE=standalone
      - PREFER_HOST_MODE=ip
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_PORT=3306
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=root
      - MYSQL_SERVICE_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_SERVICE_DB_PARAM=characterEncoding=utf8&connectTimeout=1000&socketTimeout=3000&autoReconnect=true&useSSL=false&allowPublicKeyRetrieval=true
      - NACOS_AUTH_ENABLE=true
      - NACOS_AUTH_TOKEN=${NACOS_AUTH_TOKEN}
      - NACOS_AUTH_IDENTITY_KEY=serverIdentity
      - NACOS_AUTH_IDENTITY_VALUE=security
      - NACOS_SERVER_PORT=8848
      - NACOS_APPLICATION_PORT=8848
      - JVM_XMS=1g
      - JVM_XMX=1g
      - JVM_XMN=512m
    expose:
      - "8080"
      - "9848"
    volumes:
      - nacos-data:/home/nacos/data
    networks:
      - npass
    depends_on:
      mysql:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 60s
    logging: *default-logging

  # ==================== Kafka (KRaft Mode) ====================
  kafka:
    image: confluentinc/cp-kafka:7.8.0
    container_name: tiz-kafka
    restart: always
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      CLUSTER_ID: ${KAFKA_CLUSTER_ID}
      KAFKA_LISTENERS: BROKER://kafka:9092,CONTROLLER://kafka:9093
      KAFKA_ADVERTISED_LISTENERS: BROKER://kafka:9092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: BROKER:PLAINTEXT,CONTROLLER:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: BROKER
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_SEGMENT_BYTES: 1073741824
      KAFKA_LOG_RETENTION_CHECK_INTERVAL_MS: 300000
      KAFKA_NUM_PARTITIONS: 6
      KAFKA_DEFAULT_REPLICATION_FACTOR: 1
      KAFKA_MIN_INSYNC_REPLICAS: 1
      KAFKA_HEAP_OPTS: "-Xmx2g -Xms2g"
    expose:
      - "9092"
    volumes:
      - kafka-data:/var/lib/kafka/data
    networks:
      - npass
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 60s
    logging: *default-logging
