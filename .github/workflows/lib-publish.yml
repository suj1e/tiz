name: Publish Libraries

on:
  push:
    branches: [main]
    paths:
      - 'tiz-backend/common/**'
      - 'tiz-backend/llmsrv-api/**'
      - 'tiz-backend/contentsrv/api/**'
  workflow_dispatch:
    inputs:
      library:
        description: 'Library to publish (all/common/llmsrv-api/contentsrv-api)'
        required: false
        default: 'all'

env:
  REGISTRY: ghcr.io

jobs:
  publish-common:
    if: contains(github.event.inputs.library, 'all') || contains(github.event.inputs.library, 'common') || github.event.inputs.library == ''
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Publish common
        working-directory: tiz-backend/common
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

  publish-llmsrv-api:
    if: contains(github.event.inputs.library, 'all') || contains(github.event.inputs.library, 'llmsrv-api') || github.event.inputs.library == ''
    needs: publish-common
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Publish llmsrv-api
        working-directory: tiz-backend/llmsrv-api
        run: ./gradlew publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

  publish-contentsrv-api:
    if: contains(github.event.inputs.library, 'all') || contains(github.event.inputs.library, 'contentsrv-api') || github.event.inputs.library == ''
    needs: [publish-common, publish-llmsrv-api]
    runs-on: ubuntu-latest
    permissions:
      packages: write
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Publish contentsrv-api
        working-directory: tiz-backend/contentsrv
        run: ./gradlew :api:publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}

  trigger-services:
    needs: [publish-common, publish-llmsrv-api, publish-contentsrv-api]
    if: always() && needs.publish-common.result == 'success'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger dependent service builds
        uses: actions/github-script@v7
        with:
          script: |
            // Trigger all Java service workflows when libraries are updated
            const services = ['authsrv', 'chatsrv', 'contentsrv', 'practicesrv', 'quizsrv', 'usersrv', 'gatewaysrv'];
            for (const svc of services) {
              await github.rest.actions.createWorkflowDispatch({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: `srv-${svc}.yml`,
                ref: 'main',
                inputs: { reason: 'library-updated' }
              });
            }
