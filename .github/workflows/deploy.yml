name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      services:
        description: 'Services to deploy (comma-separated or "all")'
        required: false
        default: 'all'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: suj1e/tiz

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://tiz.dmall.ink

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "name=latest" >> $GITHUB_OUTPUT
          fi

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          cat > .env << 'EOF'
          IMAGE_TAG=${{ steps.tag.outputs.name }}

          # MySQL
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.MYSQL_PASSWORD }}

          # Redis
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SPRING_DATA_REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          # Elasticsearch
          ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }}

          # Nacos
          NACOS_AUTH_TOKEN=${{ secrets.NACOS_AUTH_TOKEN }}
          NACOS_PASSWORD=${{ secrets.NACOS_PASSWORD }}

          # Security
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION=86400000

          # LLM Service
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE=${{ secrets.OPENAI_API_BASE }}
          OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}

          # Application
          SPRING_PROFILES_ACTIVE=prod
          VITE_API_BASE_URL=https://api.tiz.dmall.ink
          EOF
          ENDSSH

      - name: Deploy to server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          # Pull latest images
          docker-compose -f deploy/docker-compose.yml --env-file .env pull

          # Restart services
          docker-compose -f deploy/docker-compose.yml --env-file .env up -d

          # Cleanup old images
          docker image prune -f
          ENDSSH

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}
          docker-compose -f deploy/docker-compose.yml --env-file .env ps
          ENDSSH
