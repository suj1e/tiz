name: Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: suj1e/tiz

jobs:
  build-and-push:
    name: Build and Push Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        include:
          # Java Services
          - service: gatewaysrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.gateway
            build_args: |
              SERVICE_NAME=gatewaysrv
              PORT=8080
            port: 8080
          - service: authsrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.java
            build_args: |
              SERVICE_NAME=authsrv
              PORT=8101
            port: 8101
          - service: chatsrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.java
            build_args: |
              SERVICE_NAME=chatsrv
              PORT=8102
            port: 8102
          - service: contentsrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.java
            build_args: |
              SERVICE_NAME=contentsrv
              PORT=8103
            port: 8103
          - service: practicesrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.java
            build_args: |
              SERVICE_NAME=practicesrv
              PORT=8104
            port: 8104
          - service: quizsrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.java
            build_args: |
              SERVICE_NAME=quizsrv
              PORT=8105
            port: 8105
          - service: usersrv
            context: .
            dockerfile: tiz-backend/docker/Dockerfile.java
            build_args: |
              SERVICE_NAME=usersrv
              PORT=8107
            port: 8107
          # Frontend
          - service: tiz-web
            context: tiz-web
            dockerfile: tiz-web/Dockerfile
            build_args: ''
            port: 80
          # Python Service
          - service: llmsrv
            context: tiz-backend/llmsrv
            dockerfile: tiz-backend/llmsrv/Dockerfile
            build_args: ''
            port: 8106

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract tag name
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "name=latest" >> $GITHUB_OUTPUT
          fi

      - name: Build and push ${{ matrix.service }}
        uses: docker/build-push-action@v6
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          build-args: ${{ matrix.build_args }}
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:${{ steps.tag.outputs.name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/${{ matrix.service }}:latest
          labels: |
            org.opencontainers.image.source=${{ github.repositoryUrl }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          cache-from: type=gha,scope=${{ matrix.service }}
          cache-to: type=gha,scope=${{ matrix.service }},mode=max
          platforms: linux/amd64

  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: production
      url: https://tiz.dmall.ink

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract tag name
        id: tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            echo "name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "name=latest" >> $GITHUB_OUTPUT
          fi

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create .env file on server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          # Create unified .env file for all services
          cat > .env << 'EOF'
          # ==================== Image Configuration ====================
          IMAGE_TAG=${{ steps.tag.outputs.name }}

          # ==================== MySQL Configuration ====================
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          SPRING_DATASOURCE_PASSWORD=${{ secrets.MYSQL_PASSWORD }}

          # ==================== Redis Configuration ====================
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          SPRING_DATA_REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}

          # ==================== Elasticsearch Configuration ====================
          ELASTIC_PASSWORD=${{ secrets.ELASTIC_PASSWORD }}

          # ==================== Nacos Configuration ====================
          NACOS_AUTH_TOKEN=${{ secrets.NACOS_AUTH_TOKEN }}
          NACOS_PASSWORD=${{ secrets.NACOS_PASSWORD }}

          # ==================== Security Configuration ====================
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION=86400000

          # ==================== LLM Service Configuration ====================
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          OPENAI_API_BASE=${{ secrets.OPENAI_API_BASE }}
          OPENAI_MODEL=${{ secrets.OPENAI_MODEL }}

          # ==================== Kafka Configuration ====================
          KAFKA_BOOTSTRAP_SERVERS=172.28.0.15:9094

          # ==================== Application Configuration ====================
          SPRING_PROFILES_ACTIVE=prod
          VITE_API_BASE_URL=https://api.tiz.dmall.ink
          EOF

          echo "Created .env file"
          ENDSSH

      - name: Deploy to server
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          # Pull latest images
          docker-compose -f deploy/docker-compose.yml --env-file .env pull

          # Restart services
          docker-compose -f deploy/docker-compose.yml --env-file .env up -d

          # Cleanup old images
          docker image prune -f

          echo "Deployment completed successfully"
          ENDSSH

      - name: Health check
        run: |
          sleep 10
          ssh -i ~/.ssh/deploy_key ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'ENDSSH'
          set -e
          cd ${{ secrets.DEPLOY_PATH }}

          # Check all services are healthy
          docker-compose -f deploy/docker-compose.yml --env-file .env ps

          echo "All services deployed and running"
          ENDSSH

      - name: Notify deployment success
        if: success()
        run: |
          echo "Deployment completed successfully"
          echo "Version: ${{ steps.tag.outputs.name }}"
          echo "URL: https://tiz.dmall.ink"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "Deployment failed. Check the logs for details."
