version: '3.9'

# 全局日志配置 - 限制日志大小防止系统盘被占满
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

# Java 服务通用配置
x-java-service: &java-service
  restart: always
  environment:
    - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
    - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
    - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
    - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
    - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
    - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
    - JAVA_OPTS=${JAVA_OPTS:--Xms256m -Xmx512m}
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M
  healthcheck:
    interval: 15s
    timeout: 10s
    retries: 5
    start_period: 60s
  logging: *default-logging

# Python 服务通用配置
x-python-service: &python-service
  restart: always
  environment:
    - PYTHONUNBUFFERED=1
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 512M
  healthcheck:
    interval: 15s
    timeout: 10s
    retries: 5
    start_period: 30s
  logging: *default-logging

networks:
  npass:
    external: true

services:
  # ==================== Frontend ====================
  tiz-web:
    image: ${TIZ_WEB_IMAGE:-ghcr.io/suj1e/tiz/tiz-web}:${IMAGE_TAG:-latest}
    container_name: tiz-web
    restart: always
    ports:
      - "${WEB_PORT:-80}:80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-https://api.tiz.dmall.ink}
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    networks:
      - npass
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging: *default-logging

  # ==================== API Gateway ====================
  gatewaysrv:
    image: ${GATEWAYSRV_IMAGE:-ghcr.io/suj1e/tiz/gatewaysrv}:${IMAGE_TAG:-latest}
    container_name: tiz-gatewaysrv
    <<: *java-service
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${GATEWAY_JAVA_OPTS:--Xms256m -Xmx512m}
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      authsrv:
        condition: service_healthy
      chatsrv:
        condition: service_healthy
      contentsrv:
        condition: service_healthy
      practicesrv:
        condition: service_healthy
      quizsrv:
        condition: service_healthy
      llmsrv:
        condition: service_healthy
      usersrv:
        condition: service_healthy

  # ==================== Auth Service ====================
  authsrv:
    image: ${AUTHSRV_IMAGE:-ghcr.io/suj1e/tiz/authsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-authsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${AUTHSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/actuator/health"]

  # ==================== Chat Service ====================
  chatsrv:
    image: ${CHATSRV_IMAGE:-ghcr.io/suj1e/tiz/chatsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-chatsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${CHATSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9094}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8102/actuator/health"]

  # ==================== Content Service ====================
  contentsrv:
    image: ${CONTENTSRV_IMAGE:-ghcr.io/suj1e/tiz/contentsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-contentsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${CONTENTSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8103/actuator/health"]

  # ==================== Practice Service ====================
  practicesrv:
    image: ${PRACTICESRV_IMAGE:-ghcr.io/suj1e/tiz/practicesrv}:${IMAGE_TAG:-latest}
    container_name: tiz-practicesrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${PRACTICESRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9094}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8104/actuator/health"]

  # ==================== Quiz Service ====================
  quizsrv:
    image: ${QUIZSRV_IMAGE:-ghcr.io/suj1e/tiz/quizsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-quizsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${QUIZSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8105/actuator/health"]

  # ==================== LLM Service ====================
  llmsrv:
    image: ${LLMSRV_IMAGE:-ghcr.io/suj1e/tiz/llmsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-llmsrv
    <<: *python-service
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=${LLM_DATABASE_URL:-mysql+pymysql://tiz:Tiz@2026@mysql:3306/tiz}
      - REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-kafka:9094}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8106/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ==================== User Service ====================
  usersrv:
    image: ${USERSRV_IMAGE:-ghcr.io/suj1e/tiz/usersrv}:${IMAGE_TAG:-latest}
    container_name: tiz-usersrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-nacos:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${USERSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://mysql:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-redis}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
    networks:
      - npass
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8107/actuator/health"]

# ==================== Infrastructure Dependencies ====================
# mysql, redis, kafka are defined in infra/docker-compose.yml
# Services connect to them via npass network using DNS names:
#   - mysql:3306
#   - redis:6379
#   - kafka:9094
#   - nacos:8848
#
# Note: depends_on cannot check health of external containers.
# Start infra first: docker-compose -f infra/docker-compose.yml up -d
# Then start apps: docker-compose -f deploy/docker-compose.yml up -d
