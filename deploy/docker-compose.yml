version: '3.9'

# 全局日志配置 - 限制日志大小防止系统盘被占满
x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"

# Java 服务通用配置
x-java-service: &java-service
  restart: always
  environment:
    - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
    - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
    - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
    - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
    - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
    - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
    - JAVA_OPTS=${JAVA_OPTS:--Xms256m -Xmx512m}
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M
  healthcheck:
    interval: 15s
    timeout: 10s
    retries: 5
    start_period: 60s
  logging: *default-logging

# Python 服务通用配置
x-python-service: &python-service
  restart: always
  environment:
    - PYTHONUNBUFFERED=1
  deploy:
    resources:
      limits:
        memory: 1G
      reservations:
        memory: 512M
  healthcheck:
    interval: 15s
    timeout: 10s
    retries: 5
    start_period: 30s
  logging: *default-logging

networks:
  npass:
    name: npass
    external: true
  tiz-backend:
    name: tiz-backend
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
  tiz-network:
    name: tiz-network
    external: true

services:
  # ==================== Frontend ====================
  tiz-web:
    image: ${TIZ_WEB_IMAGE:-ghcr.io/suj1e/tiz/tiz-web}:${IMAGE_TAG:-latest}
    container_name: tiz-web
    restart: always
    ports:
      - "${WEB_PORT:-80}:80"
    environment:
      - VITE_API_BASE_URL=${VITE_API_BASE_URL:-https://api.tiz.dmall.ink}
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
    networks:
      - npass
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging: *default-logging

  # ==================== API Gateway ====================
  gatewaysrv:
    image: ${GATEWAYSRV_IMAGE:-ghcr.io/suj1e/tiz/gatewaysrv}:${IMAGE_TAG:-latest}
    container_name: tiz-gatewaysrv
    <<: *java-service
    ports:
      - "${GATEWAY_PORT:-8080}:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${GATEWAY_JAVA_OPTS:--Xms256m -Xmx512m}
      - GATEWAY_ROUTES_AUTHSRV_URL=http://authsrv:8101
      - GATEWAY_ROUTES_CHATSRV_URL=http://chatsrv:8102
      - GATEWAY_ROUTES_CONTENTSRV_URL=http://contentsrv:8103
      - GATEWAY_ROUTES_PRACTICESRV_URL=http://practicesrv:8104
      - GATEWAY_ROUTES_QUIZSRV_URL=http://quizsrv:8105
      - GATEWAY_ROUTES_LLSMSRV_URL=http://llmsrv:8106
      - GATEWAY_ROUTES_USERSRV_URL=http://usersrv:8107
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    networks:
      npass:
        ipv4_address: 172.20.0.10
      tiz-backend:
        ipv4_address: 172.29.0.10
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      authsrv:
        condition: service_healthy
      chatsrv:
        condition: service_healthy
      contentsrv:
        condition: service_healthy
      practicesrv:
        condition: service_healthy
      quizsrv:
        condition: service_healthy
      llmsrv:
        condition: service_healthy
      usersrv:
        condition: service_healthy

  # ==================== Auth Service ====================
  authsrv:
    image: ${AUTHSRV_IMAGE:-ghcr.io/suj1e/tiz/authsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-authsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${AUTHSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://172.28.0.10:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.20
      tiz-network:
        ipv4_address: 172.28.0.20
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8101/actuator/health"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==================== Chat Service ====================
  chatsrv:
    image: ${CHATSRV_IMAGE:-ghcr.io/suj1e/tiz/chatsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-chatsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${CHATSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://172.28.0.10:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-172.28.0.15:9094}
      - LLM_SERVICE_URL=http://llmsrv:8106
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.21
      tiz-network:
        ipv4_address: 172.28.0.21
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8102/actuator/health"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy
      llmsrv:
        condition: service_healthy

  # ==================== Content Service ====================
  contentsrv:
    image: ${CONTENTSRV_IMAGE:-ghcr.io/suj1e/tiz/contentsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-contentsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${CONTENTSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://172.28.0.10:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.22
      tiz-network:
        ipv4_address: 172.28.0.22
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8103/actuator/health"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==================== Practice Service ====================
  practicesrv:
    image: ${PRACTICESRV_IMAGE:-ghcr.io/suj1e/tiz/practicesrv}:${IMAGE_TAG:-latest}
    container_name: tiz-practicesrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${PRACTICESRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://172.28.0.10:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-172.28.0.15:9094}
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.23
      tiz-network:
        ipv4_address: 172.28.0.23
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8104/actuator/health"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      kafka:
        condition: service_healthy

  # ==================== Quiz Service ====================
  quizsrv:
    image: ${QUIZSRV_IMAGE:-ghcr.io/suj1e/tiz/quizsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-quizsrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${QUIZSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://172.28.0.10:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.24
      tiz-network:
        ipv4_address: 172.28.0.24
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8105/actuator/health"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==================== LLM Service ====================
  llmsrv:
    image: ${LLMSRV_IMAGE:-ghcr.io/suj1e/tiz/llmsrv}:${IMAGE_TAG:-latest}
    container_name: tiz-llmsrv
    <<: *python-service
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=${LLM_DATABASE_URL:-mysql+pymysql://tiz:Tiz@2026@172.28.0.10:3306/tiz}
      - REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-172.28.0.15:9094}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_API_BASE=${OPENAI_API_BASE:-https://api.openai.com/v1}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - LANGCHAIN_API_KEY=${LANGCHAIN_API_KEY:-}
      - LANGCHAIN_TRACING_V2=${LANGCHAIN_TRACING_V2:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.25
      tiz-network:
        ipv4_address: 172.28.0.25
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8106/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==================== User Service ====================
  usersrv:
    image: ${USERSRV_IMAGE:-ghcr.io/suj1e/tiz/usersrv}:${IMAGE_TAG:-latest}
    container_name: tiz-usersrv
    <<: *java-service
    environment:
      - SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE:-prod}
      - NACOS_SERVER_ADDR=${NACOS_SERVER_ADDR:-172.28.0.14:8848}
      - NACOS_NAMESPACE=${NACOS_NAMESPACE:-}
      - NACOS_GROUP=${NACOS_GROUP:-DEFAULT_GROUP}
      - NACOS_USERNAME=${NACOS_USERNAME:-nacos}
      - NACOS_PASSWORD=${NACOS_PASSWORD:-nacos}
      - JAVA_OPTS=${USERSRV_JAVA_OPTS:--Xms256m -Xmx512m}
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL:-jdbc:mysql://172.28.0.10:3306/tiz?useSSL=false&serverTimezone=Asia/Shanghai&characterEncoding=utf8}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME:-tiz}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD:-Tiz@2026}
      - SPRING_DATA_REDIS_HOST=${SPRING_DATA_REDIS_HOST:-172.28.0.11}
      - SPRING_DATA_REDIS_PORT=${SPRING_DATA_REDIS_PORT:-6379}
      - SPRING_DATA_REDIS_PASSWORD=${SPRING_DATA_REDIS_PASSWORD:-}
    networks:
      tiz-backend:
        ipv4_address: 172.29.0.26
      tiz-network:
        ipv4_address: 172.28.0.26
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8107/actuator/health"]
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy

  # ==================== Infrastructure Dependencies (Reference) ====================
  # These services are defined in docker-compose-lite.yml
  # This section documents the expected healthcheck dependencies
  mysql:
    image: docker.m.daocloud.io/library/mysql:9.2
    container_name: tiz-mysql
    networks:
      tiz-network:
        ipv4_address: 172.28.0.10
    external: true

  redis:
    image: docker.m.daocloud.io/library/redis:7.4-alpine
    container_name: tiz-redis
    networks:
      tiz-network:
        ipv4_address: 172.28.0.11
    external: true

  kafka:
    image: docker.m.daocloud.io/confluentinc/cp-kafka:7.8.0
    container_name: tiz-kafka
    networks:
      tiz-network:
        ipv4_address: 172.28.0.15
    external: true
